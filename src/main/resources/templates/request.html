<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト希望登録</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales-all.min.js'></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var selectedDates = [];
            var removedDates = [];

            var events = /*[[${eventsJson}]]*/ '[]';
            try {
                events = JSON.parse(events);
            } catch (e) {
                console.error("Error parsing events JSON", e);
            }

            events.forEach(event => {
                selectedDates.push(event.start);
                event.id = event.start;  // 初期表示のイベントにもIDを設定
                // ユーザーの色を直接設定
                if (event.color) {
                    event.color = event.color;
                } else {
                    event.color = '#0000FF'; // デフォルトの色を設定
                }
            });

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                selectable: true,
                unselectAuto: false,
                events: events,  // 初期表示のイベントを設定
                select: function(info) {
                    var dateStr = info.startStr;
                    if (!selectedDates.includes(dateStr)) {
                        selectedDates.push(dateStr);
                        calendar.addEvent({
                            id: dateStr,
                            title: /*[[${user.name}]]*/ 'ユーザー名',
                            start: dateStr,
                            allDay: true,
                            color: /*[[${user.color}]]*/ '#0000FF'  // ユーザーの色を設定
                        });
                    }
                },
                eventContent: function(arg) {
                    var userName = arg.event.title;
                    var dateStr = arg.event.startStr;
                    var innerHtml = `
                        <div>
                            ${userName}
                            <button type="button" class="close-btn text-red-500 ml-2" data-date="${dateStr}">&times;</button>
                        </div>`;
                    return { html: innerHtml };
                }
            });

            calendar.render();

            // 削除ボタンの動作を設定する
            document.getElementById('calendar').addEventListener('click', function(event) {
                if (event.target.classList.contains('close-btn')) {
                    var dateStr = event.target.getAttribute('data-date');
                    selectedDates = selectedDates.filter(date => date !== dateStr);
                    removedDates.push(dateStr);
                    var calendarEvent = calendar.getEventById(dateStr);
                    if (calendarEvent) {
                        calendarEvent.remove();
                    }
                }
            });

            document.getElementById('submit-button').addEventListener('click', function() {
                var datesInput = document.getElementById('dates-input');
                datesInput.value = selectedDates.join(',');

                removedDates.forEach(dateStr => {
                    fetch('/shift/request/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ date: dateStr, userId: /*[[${user.id}]]*/ 0 })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log("Event deleted successfully");
                        } else {
                            console.error("Failed to delete event: " + data.message);
                        }
                    }).catch(error => {
                        console.error("Error deleting event: ", error);
                    });
                });
            });
        });
        /*]]>*/
    </script>
</head>
<body class="bg-gray-100">
<nav class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-2 flex justify-between items-center">
        <div class="text-2xl font-bold text-gray-800">シフト管理アプリ</div>
        <ul class="flex space-x-4">
            <li><a th:href="@{/user}" class="text-gray-800 hover:text-gray-600">ユーザー登録・削除</a></li>
            <li><a th:href="@{/shift/request/user_select}" class="text-gray-800 hover:text-gray-600">シフト希望登録</a></li>
            <li><a th:href="@{/manager}" class="text-gray-800 hover:text-gray-600">管理者ページ</a></li>
        </ul>
    </div>
</nav>
<div class="container mx-auto mt-8 px-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-4"><span th:text="${user.name}"></span>のシフト登録画面</h1>
    <form th:action="@{/shift/request}" method="post" class="bg-white p-6 rounded shadow-md">
        <input type="hidden" name="userId" th:value="${user.id}" />
        <input type="hidden" id="dates-input" name="dates" />

        <div id='calendar' class="mb-4"></div>

        <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">シフト提出</button>
    </form>
    <a th:href="@{/}" class="text-lg text-blue-600 hover:underline mt-6 block">ホームへ戻る</a>
</div>
</body>
</html>
